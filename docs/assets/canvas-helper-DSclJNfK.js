import{a as P,r as b}from"./math-DVpWUKCU.js";import{d as R}from"./conversion-CGf7QoDW.js";import{i as S}from"./indexing-Xa_Aovu7.js";import{S as N}from"./simple-event-emitter-BaCTAiR9.js";import{d as m,e as E,g as C}from"./guard-BPeP3-pA.js";import{a as L}from"./placeholder-DHFnYwCJ.js";import{a as M}from"./guard-RzpFIjKH.js";import{t as k,a as I,b as A,E as F}from"./element-sizing-Blh1KTfT.js";import{r as H}from"./resolve-el-BUhvOf7L.js";function T(i,t,e){let s=typeof t=="number"?t:t.width,r=typeof t=="number"?e:t.height;if(s===void 0)throw new Error("Param 'width' undefined");if(r===void 0)throw new Error("Param 'height' undefined");if(s=i(s,"width"),r=i(r,"height"),typeof t=="object")if(m(t)){const n=i(t.x,"x"),a=i(t.y,"y");return{...t,width:s,height:r,x:n,y:a}}else return{...t,width:s,height:r};return{width:s,height:r}}function D(i,t,e){return m(t)?Object.freeze({...t,x:i(t.x,e),y:i(t.y,e),width:i(t.width,e),height:i(t.height,e)}):Object.freeze({...t,width:i(t.width,e),height:i(t.height,e)})}const $=(...i)=>{if(i===void 0)throw new Error("parameter 'p' is undefined");if(i.length<2)return!0;for(let t=1;t<i.length;t++)if(i[t].x!==i[0].x||i[t].y!==i[0].y)return!1;return!0},j=(i,t)=>m(i)&&m(t)?$(i,t)?i.width===t.width&&i.height===t.height:!1:!m(i)&&!m(t)?i.width===t.width&&i.height===t.height:!1,B=(i,t)=>i*t;function q(i,t){return D(B,i,t)}const X=i=>{const t=[];for(const e in i){const s=i[e];k(s)&&t.push([e,s])}return Object.fromEntries(t)},y=(i="both",t)=>{const e=t??L;let s=1,r=1,n={x:1,y:1};const a=()=>{switch(i){case"height":return{x:r,y:r};case"width":return{x:s,y:s};case"min":return{x:Math.min(s,r),y:Math.min(s,r)};case"max":return{x:Math.max(s,r),y:Math.max(s,r)};default:return{x:s,y:r}}},l=(u,h,o,c)=>{let d=Number.NaN,x=Number.NaN,f=e.width,g=e.height;if(typeof u=="number")if(d=u,typeof h=="number"){if(x=h,o===void 0)return[d,x,f,g];if(E(o))f=o.width,g=o.height;else if(typeof o=="number")if(f=o,typeof c=="number")g=c;else throw new TypeError("Missing final height value");else throw new Error("Missing valid output range")}else if(E(h))f=h.width,g=h.height;else throw new Error("Expected input y or output Rect to follow first number parameter");else if(M(u)){if(d=u.x,x=u.y,h===void 0)return[d,x,f,g];if(E(h))f=h.width,g=h.height;else if(typeof h=="number")if(f=h,typeof o=="number")g=o;else throw new TypeError("Expected height as third parameter after Point and output width");else throw new TypeError("Expected Rect or width as second parameter when first parameter is a Point")}else throw new Error("Expected input Point or x value as first parameter");return[d,x,f,g]},w=(u,h,o,c)=>{const d=l(u,h,o,c);return v(!0,...d)},p=(u,h,o,c)=>{const d=l(u,h,o,c);return v(!1,...d)},v=(u,h,o,c,d)=>{if(Number.isNaN(c))throw new Error("Output width range missing");if(Number.isNaN(d))throw new Error("Output height range missing");return(c!==s||d!==r)&&(s=c,r=d,n=a()),u?{x:h*n.x,y:o*n.y}:{x:h/n.x,y:o/n.y}};return{computeScale:a,rel:p,abs:w,width:e.width,height:e.height}},z=i=>({rows:i.width,cols:i.height}),Y=i=>{const t=z(i),e=i.data;return(r,n="undefined")=>{const a=S(t,r,n);if(a===void 0)return;const l=a*4;return{r:e[l],g:e[l+1],b:e[l+2],opacity:e[l+3],unit:"8bit",space:"srgb"}}},Z=i=>{const t=z(i),e=i.data;return(r,n,a="undefined")=>{const l=S(t,n,a);if(l===void 0)throw new Error(`Cell out of range. ${n.x},${n.y}`);const w=R(r),p=l*4;e[p]=w.r,e[p+1]=w.g,e[p+2]=w.b,e[p+3]=w.opacity??255}};class tt extends N{el;opts;#s;#r;#h=I;#t=A;#e;#o;#n;#a=!1;constructor(t,e={}){if(super(),!t)throw new Error("Param 'domQueryOrEl' is null or undefined");if(this.el=H(t),this.el.nodeName!=="CANVAS")throw new Error(`Expected CANVAS HTML element. Got: ${this.el.nodeName}`);const s=this.el.getBoundingClientRect();this.opts={resizeLogic:e.resizeLogic??"none",disablePointerEvents:e.disablePointerEvents??!1,pixelZoom:e.pixelZoom??(window.devicePixelRatio||1),height:e.height??s.height,width:e.width??s.width,zIndex:e.zIndex??-1,coordinateScale:e.coordinateScale??"both",onResize:e.onResize,clearOnResize:e.clearOnResize??!0,draw:e.draw,skipCss:e.skipCss??!1,colourSpace:"srgb"},this.#s=y("both"),this.#r=y("both",s),this.#l()}getRectangle(){return{x:0,y:0,...this.#t}}dispose(t){this.#a||(this.#a=!0,this.#n&&(this.#n.dispose(`CanvasHelper disposing ${t}`.trim()),this.#n=void 0))}#i(t=!1){if(this.#e===void 0||t){const e=this.ratio,s=this.el.getContext("2d");if(s===null)throw new Error("Could not create drawing context");this.#e=s,s.setTransform(1,0,0,1,0,0),s.scale(e,e)}return this.#e}getPhysicalSize(){return{width:this.width*this.ratio,height:this.height*this.ratio}}getDrawHelper(){this.#o||(this.#o=P(this.#i(),{width:this.width,height:this.height}))}setLogicalSize(t){C(t,"logicalSize");const e=T(a=>Math.floor(a),t),s=this.opts.pixelZoom;this.#s=y(this.opts.coordinateScale,t),this.#r=y("both",t);const r=q(t,s);this.el.width=r.width,this.el.height=r.height,this.el.style.width=e.width.toString()+"px",this.el.style.height=e.height.toString()+"px",this.#i(!0),this.opts.clearOnResize&&this.ctx.clearRect(0,0,this.width,this.height),this.#t=e;const n=this.opts.onResize;n&&setTimeout(()=>{n(this.ctx,this.size,this)},100),this.fireEvent("resize",{ctx:this.ctx,size:this.#t,helper:this})}#l(){const t=this.opts.draw;if(t){const s=()=>{t(this.ctx,this.#t,this),requestAnimationFrame(s)};setTimeout(()=>{s()},100)}if(this.opts.disablePointerEvents||this.#d(),(this.opts.resizeLogic??"none")==="none")this.setLogicalSize({width:this.opts.width,height:this.opts.height});else{const s={onSetSize:r=>{j(this.#t,r)||this.setLogicalSize(r)},naturalSize:{width:this.opts.width,height:this.opts.height},stretch:this.opts.resizeLogic??"none"};this.#n=new F(this.el,s)}this.#i()}#d(){const t=e=>{const{offsetX:s,offsetY:r}=e,n=s*this.ratio,a=r*this.ratio;e=X(e);const l={physicalX:n,physicalY:a,...e};switch(e.type){case"pointerup":{this.fireEvent("pointerup",l);break}case"pointermove":{this.fireEvent("pointermove",l);break}case"pointerdown":{this.fireEvent("pointerup",l);break}}};this.el.addEventListener("pointermove",t),this.el.addEventListener("pointerdown",t),this.el.addEventListener("pointerup",t)}clear(){this.#e&&this.#e.clearRect(0,0,this.width,this.height)}fill(t){this.#e&&(t&&(this.#e.fillStyle=t),this.#e.fillRect(0,0,this.width,this.height))}get ctx(){if(this.#e===void 0)throw new Error("Context not available");return this.#i()}get viewport(){return this.#h}get width(){return this.#t.width}get height(){return this.#t.height}get size(){return this.#t}get ratio(){return window.devicePixelRatio||1}get dimensionMin(){return Math.min(this.width,this.height)}get dimensionMax(){return Math.max(this.width,this.height)}drawBounds(t="green"){const e=this.#i();b(e,{x:0,y:0,width:this.width,height:this.height},{crossed:!0,strokeStyle:t,strokeWidth:1}),b(e,this.#h,{crossed:!0,strokeStyle:"silver",strokeWidth:3})}get toRelative(){return this.#s.rel}get toAbsoluteFixed(){return this.#r.abs}get toRelativeFixed(){return this.#r.rel}get logicalCenter(){return{x:this.#t.width/2,y:this.#t.height/2}}get toAbsolute(){return this.#s.abs}get center(){return{x:this.width/2,y:this.height/2}}getImageData(){const t=this.getPhysicalSize(),e=this.ctx.getImageData(0,0,t.width,t.height,{colorSpace:this.opts.colourSpace});if(e==null)throw new Error("Could not get image data from context");return e}getWritableBuffer(){const t=this.ctx,e=this.getImageData(),s=z(e),r=Y(e),n=Z(e);return{grid:s,get:r,set:n,flip:()=>{t.putImageData(e,0,0)}}}}export{tt as C};
