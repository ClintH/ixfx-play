import{S as u}from"./simple-event-emitter-BaCTAiR9.js";import{S as f}from"./with-events-BRQckvzl.js";import{t as d,q as c}from"./index-C_lhlGLx.js";import{b as o}from"./scale-KzsViUdl.js";const p=()=>{let n=performance.now();return{reset:()=>{n=performance.now()},get elapsed(){return performance.now()-n}}},v=Object.freeze({attack:["decay","release"],decay:["sustain","release"],sustain:["release"],release:["complete"],complete:null}),l=Object.freeze({attackDuration:600,decayDuration:200,releaseDuration:800,shouldLoop:!1});class g extends u{#e;#i;#t;#s;#a;#r=!1;#n=!1;attackDuration;decayDuration;releaseDuration;decayDurationTotal;shouldLoop;constructor(e={}){super(),this.attackDuration=e.attackDuration??l.attackDuration,this.decayDuration=e.decayDuration??l.decayDuration,this.releaseDuration=e.releaseDuration??l.releaseDuration,this.shouldLoop=e.shouldLoop??l.shouldLoop,this.#e=new f(v,{initial:"attack"}),this.#e.addEventListener("change",t=>{t.newState==="release"&&this.#a&&this.#t?.reset(),super.fireEvent("change",t)}),this.#e.addEventListener("stop",t=>{super.fireEvent("complete",t)}),this.#i=()=>p(),this.#s=this.#a=!1,this.decayDurationTotal=this.attackDuration+this.decayDuration}dispose(){this.#r||this.#e.dispose()}get isDisposed(){return this.#r}switchStateIfNeeded(e){if(this.#t===void 0)return!1;let t=this.#t.elapsed;const i=this.#a&&!this.#s;let s=!1,a=this.#e.state;do switch(s=!1,a=this.#e.state,a){case"attack":{(t>this.attackDuration||i)&&(this.#e.next(),s=!0);break}case"decay":{(t>this.decayDurationTotal||i)&&(this.#e.next(),s=!0);break}case"sustain":{(!this.#s||i)&&(t=0,this.#e.next(),this.#t.reset(),s=!0);break}case"release":{t>this.releaseDuration&&(this.#e.next(),s=!0);break}case"complete":this.shouldLoop&&e&&this.trigger(this.#a)}while(s&&a!=="complete");return s}computeRaw(e=!0,t=!0){if(this.#t===void 0)return[void 0,0,this.#e.state];e&&this.switchStateIfNeeded(t);const i=this.#e.state,s=this.#t.elapsed;let a=0;const h=this.#e.state;switch(h){case"attack":{a=s/this.attackDuration;break}case"decay":{a=(s-this.attackDuration)/this.decayDuration;break}case"sustain":{a=1;break}case"release":{a=Math.min(s/this.releaseDuration,1);break}case"complete":return["complete",1,i];default:throw new Error(`State machine in unknown state: ${h}`)}return[h,a,i]}get isDone(){return this.#e.isDone}onTrigger(){}trigger(e=!1){this.onTrigger(),this.#n=!0,this.#e.reset(),this.#t=this.#i(),this.#s=e,this.#a=e}get hasTriggered(){return this.#n}compute(){}release(){this.isDone||!this.#a||(this.#s=!1,this.compute())}}const r=Object.freeze({attackBend:-1,decayBend:-.3,releaseBend:-.3,peakLevel:1,initialLevel:0,sustainLevel:.6,releaseLevel:0,retrigger:!1});class k{adsr;constructor(e){this.adsr=e}next(...e){this.adsr.hasTriggered||this.adsr.trigger();const t=this.adsr.compute();return{value:t[1],done:t[0]==="complete"}}get[Symbol.toStringTag](){return"Generator"}}class b extends g{attackPath;decayPath;releasePath;initialLevel;peakLevel;releaseLevel;sustainLevel;attackBend;decayBend;releaseBend;initialLevelOverride;retrigger;releasedAt;constructor(e={}){super(e),this.retrigger=e.retrigger??r.retrigger,this.initialLevel=e.initialLevel??r.initialLevel,this.peakLevel=e.peakLevel??r.peakLevel,this.releaseLevel=e.releaseLevel??r.releaseLevel,this.sustainLevel=e.sustainLevel??r.sustainLevel,this.attackBend=e.attackBend??r.attackBend,this.releaseBend=e.releaseBend??r.releaseBend,this.decayBend=e.decayBend??r.decayBend;const t=1;this.attackPath=d(c({x:0,y:this.initialLevel},{x:t,y:this.peakLevel},-this.attackBend)),this.decayPath=d(c({x:0,y:this.peakLevel},{x:t,y:this.sustainLevel},-this.decayBend)),this.releasePath=d(c({x:0,y:this.sustainLevel},{x:t,y:this.releaseLevel},-this.releaseBend))}onTrigger(){if(this.initialLevelOverride=void 0,!this.retrigger){const[e,t,i]=this.compute(!0,!1);!Number.isNaN(t)&&t>0&&(this.initialLevelOverride=t)}}[Symbol.iterator](){return new k(this)}get value(){return this.compute(!0)[1]}compute(e=!0,t=!0){const[i,s]=super.computeRaw(e,t);if(i===void 0)return[void 0,Number.NaN,Number.NaN];let a;switch(i){case"attack":{a=this.attackPath.interpolate(s).y,this.initialLevelOverride!==void 0&&(a=o(a,0,1,this.initialLevelOverride,1)),this.releasedAt=a;break}case"decay":{a=this.decayPath.interpolate(s).y,this.releasedAt=a;break}case"sustain":{a=this.sustainLevel,this.releasedAt=a;break}case"release":{a=this.releasePath.interpolate(s).y,this.releasedAt!==void 0&&(a=o(a,0,this.sustainLevel,0,this.releasedAt));break}case"complete":{a=this.releaseLevel,this.releasedAt=void 0;break}default:throw new Error(`Unknown state: ${i}`)}return[i,a,s]}}export{b as A};
