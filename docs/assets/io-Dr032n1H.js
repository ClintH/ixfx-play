import{_ as m,m as te,c as $,n as ne,d as P,f as ie,g as se,h as oe,j as I,k as re,s as ae}from"./src-2eX6lIN8-VI_Nykma.js";import{E as ce,F as O,g as D,S as y,G,H as V,I as S,J as B,K as le,L as A,M as L,Q as R,e as he,N as de}from"./src-CURfSkGx-Bgs9tt00.js";import{r as ue}from"./src-CtUbQWIP-Vt_fnXRn.js";var z=class{enc=new TextEncoder;dec=new TextDecoder("utf-8");toBuffer(e){return this.enc.encode(e)}fromBuffer(e){return this.dec.decode(e)}},W=class{buffer="";stream;constructor(e,t=`
`){this.onData=e,this.separator=t}async close(){const e=this.stream;e&&(await e.abort(),await e.close())}clear(){this.buffer=""}writable(){return this.stream===void 0&&(this.stream=this.createWritable()),this.stream}createWritable(){const e=this;return new WritableStream({write(t){e.add(t)},close(){e.clear()}})}addImpl(e){const t=e.indexOf(this.separator);if(t<0)return this.buffer+=e,"";const n=e.substring(0,t);try{this.onData(this.buffer+n),e=e.substring(n.length+this.separator.length)}catch(i){console.warn(i)}return this.buffer="",e}add(e){for(;e.length>0;)e=this.addImpl(e)}},U=class{paused=!1;queue=new R;writer;stream;closed=!1;chunkSize;constructor(e,t={}){this.dataHandler=e,this.chunkSize=t.chunkSize??-1,this.writer=he(async()=>{await this.onWrite()},t.interval??10)}async close(){if(this.closed)return;const e=this.stream?.getWriter();e?.releaseLock(),await e?.close(),this.closed=!0}clear(){if(this.closed)throw new Error("Buffer closed");this.queue=new R}writable(){if(this.closed)throw new Error("Buffer closed");return this.stream===void 0&&(this.stream=this.createWritable()),this.stream}createWritable(){const e=this;return new WritableStream({write(t){e.add(t)},close(){e.clear()}})}async onWrite(){if(this.queue.isEmpty)return!1;if(this.paused)return console.warn("WriteBuffer.onWrite: paused..."),!0;const e=this.queue.dequeue();return e===void 0?!1:(await this.dataHandler(e),!0)}get isClosed(){return this.closed}add(e){if(this.closed)throw new Error("Buffer closed");this.chunkSize>0?this.queue.enqueue(...de(e,this.chunkSize)):this.queue.enqueue(e),this.writer.start()}};const _=Object.freeze({ready:"connecting",connecting:["connected","closed"],connected:["closed"],closed:"connecting"});var fe=class extends y{states;codec;rx;tx;gatt;verboseLogging=!1;rxBuffer;txBuffer;constructor(e,t){super(),this.device=e,this.config=t,this.verboseLogging=t.debug,this.txBuffer=new U(async n=>{await this.writeInternal(n)},t),this.rxBuffer=new W(n=>{this.fireEvent("data",{data:n})}),this.codec=new z,this.states=new G(_,{initial:"ready"}),this.states.addEventListener("change",n=>{this.fireEvent("change",n),this.verbose(`${n.priorState} -> ${n.newState}`),n.priorState==="connected"&&(this.rxBuffer.clear(),this.txBuffer.clear())}),e.addEventListener("gattserverdisconnected",()=>{this.isClosed||(this.verbose("GATT server disconnected"),this.states.state="closed")}),this.verbose(`ctor ${e.name} ${e.id}`)}get isConnected(){return this.states.state==="connected"}get isClosed(){return this.states.state==="closed"}write(e){if(this.states.state!=="connected")throw new Error(`Cannot write while state is ${this.states.state}`);this.txBuffer.add(e)}async writeInternal(e){this.verbose(`writeInternal ${e}`);const t=this.tx;if(t===void 0)throw new Error("Unexpectedly without tx characteristic");try{await t.writeValue(this.codec.toBuffer(e))}catch(n){this.warn(n)}}disconnect(){this.states.state==="connected"&&this.gatt?.disconnect()}async connect(){const e=this.config.connectAttempts??3;this.states.state="connecting",this.verbose("connect");const t=this.device.gatt;if(t===void 0)throw new Error("Gatt not available on device");await V(async()=>{this.verbose("connect.retry");const n=await t.connect();this.verbose("Getting primary service");const i=await n.getPrimaryService(this.config.service);this.verbose("Getting characteristics");const s=await i.getCharacteristic(this.config.rxGattCharacteristic),o=await i.getCharacteristic(this.config.txGattCharacteristic);return s.addEventListener("characteristicvaluechanged",r=>{this.onRx(r)}),this.rx=s,this.tx=o,this.gatt=t,this.states.state="connected",await s.startNotifications(),!0},{limitAttempts:e,startAt:200})}onRx(e){if(this.rx===void 0)return;const n=e.target.value;if(n===void 0)return;let i=this.codec.fromBuffer(n.buffer);const s=S(i,19),o=S(i,17);o&&s<o&&(this.verbose("Tx plz start"),i=B(i,o,1),this.txBuffer.paused=!1),s&&s>o&&(this.verbose("Tx plz stop"),i=B(i,s,1),this.txBuffer.paused=!0),this.rxBuffer.add(i)}verbose(e){this.verboseLogging&&console.info(this.config.name,e)}log(e){console.log(this.config.name,e)}warn(e){console.warn(this.config.name,e)}},pe={};m(pe,{NordicBleDevice:()=>H,defaultOpts:()=>x});const x={chunkSize:20,service:"6e400001-b5a3-f393-e0a9-e50e24dcca9e",txGattCharacteristic:"6e400002-b5a3-f393-e0a9-e50e24dcca9e",rxGattCharacteristic:"6e400003-b5a3-f393-e0a9-e50e24dcca9e",name:"NordicDevice",connectAttempts:5,debug:!1};var H=class extends fe{constructor(e,t={}){super(e,{...x,...t})}},J=class{freqMaxRange=200;audio;parent;lastPointer={x:0,y:0};pointerDown=!1;pointerClicking=!1;pointerClickDelayMs=100;pointerDelaying=!1;waveTracker;freqTracker;el;constructor(e,t){this.audio=t,this.parent=e,this.waveTracker=A(),this.freqTracker=A(),e.innerHTML=`
    <section>
      <button id="rendererComponentToggle">ðŸ”¼</button>
      <div>
        <h1>Visualiser</h1>
        <div style="display:flex; flex-wrap: wrap">
          <div class="visPanel">
            <h2>Frequency distribution</h2>
            <br />
            <canvas id="rendererComponentFreqData" height="200" width="400"></canvas>
          </div>
          <div class="visPanel">
            <h2>Waveform</h2>
            <button id="rendererComponentWaveReset">Reset</button>
            <div>
              Press and hold on wave to measure
            </div>
            <br />
            <canvas id="rendererComponentWaveData" height="200" width="400"></canvas>
          </div>
        </div>
      </div>
    </section>
    `,this.el=e.children[0],document.getElementById("rendererComponentToggle")?.addEventListener("click",()=>{this.setExpanded(!this.isExpanded())}),this.el.addEventListener("pointermove",n=>{this.onPointer(n)}),this.el.addEventListener("pointerup",()=>{this.pointerDelaying=!1,this.pointerDown=!1}),this.el.addEventListener("pointerdown",()=>{this.pointerDelaying=!0,setTimeout(()=>{this.pointerDelaying&&(this.pointerDelaying=!1,this.pointerDown=!0)},this.pointerClickDelayMs)}),this.el.addEventListener("pointerleave",()=>{this.pointerDelaying=!1,this.pointerDown=!1}),document.getElementById("rendererComponentWaveReset")?.addEventListener("click",()=>{this.clear()})}renderFreq(e){if(!this.isExpanded()||!e)return;const t=document.getElementById("rendererComponentFreqData");if(t===null)throw new Error("Cannot find canvas element");const n=t.getContext("2d");if(n===null)throw new Error("Cannot create drawing context");const i=e.length,s=t.clientWidth,o=t.clientHeight;n.clearRect(0,0,s,o);const r=this.getPointerRelativeTo(t),a=s/i,h=oe(e);for(let c=0;c<i;c++){if(!Number.isFinite(e[c]))continue;const u=(e[c]-h.min)/this.freqMaxRange,l=Math.abs(o*u),p=o-l,g=c/i*360,d=c*a;if(n.fillStyle=`hsl(${g}, 100%, 50%)`,r.y>0&&r.y<=o&&r.x>=d&&r.x<=d+a){this.freqTracker.id!==c.toString()&&(this.freqTracker=A({id:c.toString()})),this.freqTracker.seen(e[c]);const f=this.freqTracker.getMinMaxAvg();n.fillStyle="black",this.audio&&n.fillText(`Frequency (${c}) at pointer: ${this.audio.getFrequencyAtIndex(c).toLocaleString("en")} - ${this.audio.getFrequencyAtIndex(c+1).toLocaleString("en")}`,2,10),n.fillText(`Raw value: ${e[c].toFixed(2)}`,2,20),n.fillText(`Min: ${f.min.toFixed(2)}`,2,40),n.fillText(`Max: ${f.max.toFixed(2)}`,60,40),n.fillText(`Avg: ${f.avg.toFixed(2)}`,120,40)}n.fillRect(d,p,a,l)}}isExpanded(){const e=this.el.querySelector("div");if(e===null)throw new Error("contents div not found");return e.style.display===""}setExpanded(e){const t=this.el.querySelector("div"),n=this.el.querySelector("button");if(n===null)throw new Error("Button element not found");if(t===null)throw new Error("Contents element not found");e?(t.style.display="",n.innerText="ðŸ”¼"):(t.style.display="none",n.innerText="ðŸ”½")}clear(){this.clearCanvas(document.getElementById("rendererComponentFreqData")),this.clearCanvas(document.getElementById("rendererComponentWaveData"))}clearCanvas(e){if(e===null)throw new Error("Canvas is null");const t=e.getContext("2d");if(t===null)throw new Error("Cannot create drawing context");t.fillStyle="white",t.fillRect(0,0,e.clientWidth,e.clientHeight)}renderWave(e,t=!0){if(!this.isExpanded()||!e)return;const n=document.getElementById("rendererComponentWaveData");if(n===null)throw new Error("Cannot find wave canvas");const i=n.getContext("2d");if(i===null)throw new Error("Cannot create drawing context for wave");const s=n.clientWidth,o=n.clientHeight,r=this.getPointerRelativeTo(n),a=20,h=60,c=e.length;i.fillStyle="white",i.fillRect(0,0,h,a);const w=s/c;i.fillStyle="rgba(255, 255, 255, 0.03)",i.fillRect(0,20,s,o),i.fillStyle="red",t?i.fillRect(0,o/2,s,1):i.fillRect(0,o-1,s,1),i.lineWidth=1,i.strokeStyle="black",i.beginPath();let u=0;for(let l=0;l<c;l++){const p=e[l]*o,g=t?o/2-p:o-p;l===0?i.moveTo(u,g):i.lineTo(u,g),u+=w,this.pointerDown&&this.waveTracker.seen(e[l])}if(i.lineTo(s,t?o/2:o),i.stroke(),this.pointerDown){const l=this.waveTracker.getMinMaxAvg();i.fillStyle="rgba(255,255,0,1)",i.fillRect(h,0,150,20),i.fillStyle="black",i.fillText("Min: "+l.min.toFixed(2),60,10),i.fillText("Max: "+l.max.toFixed(2),110,10),i.fillText("Avg: "+l.avg.toFixed(2),160,10)}else this.waveTracker.reset();r.y>0&&r.y<=o&&r.x>=0&&r.x<=s&&(i.fillStyle="black",i.fillText("Level: "+(1-r.y/o).toFixed(2),2,10))}getPointerRelativeTo(e){const t=e.getBoundingClientRect();return{x:this.lastPointer.x-t.left-window.scrollX,y:this.lastPointer.y-t.top-window.scrollY}}onPointer(e){this.lastPointer={x:e.pageX,y:e.pageY},e.preventDefault()}};const we=(e,t={})=>new T((n,i)=>{const s=new Float32Array(n.frequencyBinCount),o=new Float32Array(n.fftSize);n.getFloatFrequencyData(s),n.getFloatTimeDomainData(o),e(s,o,i)},t),ge=(e,t={})=>new T((n,i)=>{const s=new Float32Array(n.frequencyBinCount);n.getFloatFrequencyData(s),e(s,i)},t),me=(e,t={})=>new T((n,i)=>{const s=new Float32Array(n.fftSize);n.getFloatTimeDomainData(s),e(te(s),i)},t);var T=class{showVis;fftSize;smoothingTimeConstant;#n=!1;debug;#i=!1;visualiser;audioCtx;analyserNode;analyse;constructor(e,t={}){if(this.showVis=t.showVis??!1,this.fftSize=t.fftSize??1024,this.debug=t.debug??!1,this.smoothingTimeConstant=t.smoothingTimeConstant??.8,$(P(this.fftSize,"positive","opts.fftSize"),ne(this.smoothingTimeConstant,"percentage","opts.smoothingTimeConstant")),!ie(this.fftSize))throw new Error(`fftSize must be a power of two from 32 to 32768 (${this.fftSize})`);if(this.fftSize<32)throw new Error("fftSize must be at least 32");if(this.fftSize>32768)throw new Error("fftSize must be no greater than 32768");this.analyse=e,this.paused=!1,this.init();const n=document.querySelector("#audio-visualiser");if(n){const i=new J(n,this);i.setExpanded(this.showVis),this.visualiser=i}}init(){if(this.#i){this.debug&&console.debug("Init already in progress");return}this.#i=!0,navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{this.onMicSuccess(e)}).catch(e=>{this.#i=!1,console.error(e)})}get paused(){return this.#n}set paused(e){e!==this.#n&&(this.#n=e,e?this.debug&&console.log("Paused"):(this.debug&&console.log("Unpaused"),window.requestAnimationFrame(this.analyseLoop.bind(this))))}setup(e,t){const n=e.createAnalyser();return n.fftSize=this.fftSize,n.smoothingTimeConstant=this.smoothingTimeConstant,e.createMediaStreamSource(t).connect(n),n}onMicSuccess(e){try{const t=new AudioContext;t.addEventListener("statechange",()=>{this.debug&&console.log(`Audio context state: ${t.state}`)}),this.audioCtx=t,this.analyserNode=this.setup(t,e),window.requestAnimationFrame(this.analyseLoop.bind(this))}catch(t){this.#i=!1,console.error(t)}}analyseLoop(){if(this.paused){this.debug&&console.log("Paused");return}const e=this.analyserNode;if(e===void 0){console.warn("Analyser undefined");return}try{this.analyse(e,this)}catch(t){console.error(t)}window.requestAnimationFrame(this.analyseLoop.bind(this))}getFrequencyRangeMax(e,t,n){const i=this.sliceByFrequency(e,t,n);return se(i)}sliceByFrequency(e,t,n){const i=this.getIndexForFrequency(e),s=this.getIndexForFrequency(t);return n.slice(i,s)}getFrequencyAtIndex(e){const t=this.analyserNode,n=this.audioCtx;if(t===void 0)throw new Error("Analyser not available");if(n===void 0)throw new Error("Audio context not available");if($(P(e,"positive","index")),e>t.frequencyBinCount)throw new Error(`Index ${e} exceeds frequency bin count ${t.frequencyBinCount}`);return e*n.sampleRate/(t.frequencyBinCount*2)}getIndexForFrequency(e){const t=this.analyserNode;if(t===void 0)throw new Error("Analyser not available");const n=t.context.sampleRate/2,i=Math.round(e/n*t.frequencyBinCount);return i<0?0:i>=t.frequencyBinCount?t.frequencyBinCount-1:i}},ve=class{#n=!1;#i=new Map;filterType="lowpass";constructor(){}init(){if(!this.#n){this.#n=!0;for(const e of document.querySelectorAll("audio"))this.#i.set(e.id,j(e,this.filterType))}}get(e){return this.init(),this.#i.get(e)}};function j(e,t="lowpass"){const n=ue(e),i=new AudioContext,s=i.createMediaElementSource(n),o=i.createStereoPanner(),r=i.createGain(),a=i.createBiquadFilter();return a.type=t,s.connect(r),r.connect(o),o.connect(a),a.connect(i.destination),{pan:o,gain:r,filter:a,id:n.id,ctx:i,el:n}}function ye(e={}){const t=new AudioContext,n=e.type??"sawtooth",i=e.frequency??440,s=e.id??le(),o=t.createOscillator();o.type=n,o.frequency.setValueAtTime(i,t.currentTime);const r=t.createStereoPanner(),a=t.createGain(),h=t.createBiquadFilter();return o.connect(a),a.connect(r),r.connect(h),h.connect(t.destination),{pan:r,gain:a,filter:h,ctx:t,osc:o,id:s}}var be={};m(be,{AudioAnalyser:()=>T,AudioElements:()=>ve,AudioVisualiser:()=>J,analyserBasic:()=>we,analyserFrequency:()=>ge,analyserPeakLevel:()=>me,createFromAudioElement:()=>j,createOscillator:()=>ye});const F=(e,t,n,i,s=200,o)=>{const r={channel:t,note:n,velocity:i,command:"noteon"},a={channel:t,note:n,velocity:0,command:"noteoff"};e.send(v(r),o),e.send(v(a),window.performance.now()+s)},M=e=>{let t;const n=e[0],i=e[1],s=e[2];let o=0;if(n>=144&&n<=159?(o=n-143,t=s===0?"noteoff":"noteon"):n>=128&&n<=143?(o=n-127,t="noteoff"):n>=160&&n<=175?(o=n-159,t="poly-at"):n>=176&&n<=191?(o=n-175,t="cc"):n>=192&&n<=207?(o=n-191,t="progchange"):n>=208&&n<=223?(o=n-207,t="at"):n>=224&&n<=239&&(o=n-223,t="pitchbend"),t===void 0)throw new Error(`Unknown command: '${t}'`);return{command:t,note:i,velocity:s,channel:o}},v=e=>{const t=new Uint8Array(3);switch(t[1]=e.note,t[2]=e.velocity,e.command){case"cc":t[0]=e.channel+175;break;case"noteon":t[0]=e.channel+143;break;case"noteoff":t[0]=e.channel+127;break;case"pitchbend":t[0]=e.channel+223;break;case"poly-at":t[0]=e.channel+159;break;case"progchange":t[0]=e.channel+191;break;case"at":t[0]=e.channel+207;break;default:throw new Error(`Command not supported '${e.command}'`)}return t},xe=`0	C-1	8.176
1	C#-1	8.662
2	D-1	9.177
3	D#-1	9.723
4	E-1	10.301
5	F-1	10.913
6	F#-1	11.562
7	G-1	12.250
8	G#-1	12.978
9	A-1	13.750
10	A#-1	14.568
11	B-1	15.434
12	C0	16.352
13	C#0	17.324
14	D0	18.354
15	D#0	19.445
16	E0	20.602
17	F0	21.827
18	F#0	23.125
19	G0	24.500
20	G#0	25.957
21	A0	27.500
22	A#0	29.135
23	B0	30.868
24	C1	32.703
25	C#1	34.648
26	D1	36.708
27	D#1	38.891
28	E1	41.203
29	F1	43.654
30	F#1	46.249
31	G1	48.999
32	G#1	51.913
33	A1	55.000
34	A#1	58.270
35	B1	61.735
36	C2	65.406
37	C#2	69.296
38	D2	73.416
39	D#2	77.782
40	E2	82.407
41	F2	87.307
42	F#2	92.499
43	G2	97.999
44	G#2	103.826
45	A2	110.000
46	A#2	116.541
47	B2	123.471
48	C3	130.813
49	C#3	138.591
50	D3	146.832
51	D#3	155.563
52	E3	164.814
53	F3	174.614
54	F#3	184.997
55	G3	195.998
56	G#3	207.652
57	A3	220.000
58	A#3	233.082
59	B3	246.942
60	C4	261.626
61	C#4	277.183
62	D4	293.665
63	D#4	311.127
64	E4	329.628
65	F4	349.228
66	F#4	369.994
67	G4	391.995
68	G#4	415.305
69	A4	440.000
70	A#4	466.164
71	B4	493.883
72	C5	523.251
73	C#5	554.365
74	D5	587.330
75	D#5	622.254
76	E5	659.255
77	F5	698.456
78	F#5	739.989
79	G5	783.991
80	G#5	830.609
81	A5	880.000
82	A#5	932.328
83	B5	987.767
84	C6	1046.502
85	C#6	1108.731
86	D6	1174.659
87	D#6	1244.508
88	E6	1318.510
89	F6	1396.913
90	F#6	1479.978
91	G6	1567.982
92	G#6	1661.219
93	A6	1760.000
94	A#6	1864.655
95	B6	1975.533
96	C7	2093.005
97	C#7	2217.461
98	D7	2349.318
99	D#7	2489.016
100	E7	2637.020
101	F7	2793.826
102	F#7	2959.955
103	G7	3135.963
104	G#7	3322.438
105	A7	3520.000
106	A#7	3729.310
107	B7	3951.066
108	C8	4186.009
109	C#8	4434.922
110	D8	4698.636
111	D#8	4978.032
112	E8	5274.041
113	F8	5587.652
114	F#8	5919.911
115	G8	6271.927
116	G#8	6644.875
117	A8	7040.000
118	A#8	7458.620
119	B8	7902.133
120	C9	8372.018
121	C#9	8869.844
122	D9	9397.273
123	D#9	9956.063
124	E9	10548.080
125	F9	11175.300
126	F#9	11839.820
127	G9	12543.850`,C=[],E=()=>{if(C.length>0)return C;const e=xe.split(`
`);for(const t of e){const n=t.split("	");if(n.length!==3){console.warn(`Expected three elements, got ${n.length}. Line:`,n);continue}C.push([Number.parseInt(n[0]),n[1].toUpperCase(),Number.parseFloat(n[2])])}return C},Ee=e=>{const t=E();e=e.toUpperCase();const n=t.find(i=>i[1]===e);return n?n[0]:NaN},Ce=e=>{const t=E();e=e.toUpperCase();const n=t.find(i=>i[1]===e);return n?n[2]:NaN},K=e=>{const n=E().find(i=>i[0]===e);return n?n[1]:""},X=e=>{const n=E().find(i=>i[0]===e);return n?n[2]:NaN};var Se=class extends y{verbose=!0;#n;#i;#t=[];#e=[];#s=!0;#o=!0;#c=L(()=>this.#g(),1e3);#r=L(()=>this.#m(),1e3);constructor(){super(),this.#n={initialised:!1,errorReason:""},this.#E()}*getInUse(){for(const e of this.#t)yield e}*getInUseInput(){for(const e of this.#t)e.type==="input"&&(yield e)}*getInUseOutput(){for(const e of this.#t)e.type==="output"&&(yield e)}*known(){for(const e of this.#e)yield e}*knownInput(){for(const e of this.#e)e.type==="input"&&(yield e)}*knownOutput(){for(const e of this.#e)e.type==="output"&&(yield e)}async scan(){await this.#b();const e=this.#i;if(e){for(const[t,n]of e.inputs)this.#l(n);for(const[t,n]of e.outputs)this.#l(n);this.#s&&this.#c(),this.#o&&this.#r()}}send(e,t,n){const i=v(e);if(typeof t>"u")for(const s of this.#t)s.type==="output"&&s.send(i,n);else t.send(i,n)}sendNote(e,t,n,i,s,o){if(o===void 0)for(const r of this.getInUseOutput())this.sendNote(e,t,n,i,s,r);else F(o,e,t,n,i,s)}#l(e){e.state==="connected"?(this.#h(e),e.connection==="open"&&this.#u(e)):e.state==="disconnected"&&this.#p(e)}#a=e=>{const t=e.data,n=e.currentTarget;if(!t)return;const i=M(t);if(i.command==="noteoff"||i.command==="noteon"){this.fireEvent("message",{...i,port:n,raw:t,frequency:X(i.note),noteName:K(i.note)});return}this.fireEvent("message",{...i,port:n,raw:t})};#u(e){const t=this.#t.find(n=>n.id===e.id);if(this.#d(`onPortOpen: id: ${e.id} name: ${e.name} (${e.type})`),t){this.#d("-- bug, port already in use?");return}this.#h(e),e.type==="input"&&e.addEventListener("midimessage",this.#a),this.#t=[...this.#t,e],this.fireEvent("open",{port:e})}#f(e){this.#t.find(n=>n.id===e.id)&&(e.type==="input"&&e.removeEventListener("midimessage",this.#a),this.#t=this.#t.filter(n=>n.id!==e.id),this.fireEvent("close",{port:e}))}#h(e){this.#e.find(n=>n.id===e.id)||(this.#e=[...this.#e,e],this.fireEvent("deviceConnected",{port:e}))}#p(e){this.#e.find(n=>n.id===e.id)&&(this.#f(e),this.#e=this.#e.filter(n=>n.id!==e.id),this.fireEvent("deviceDisconnected",{port:e}))}#w(e){return this.#t.find(t=>t.id===e.id)!==void 0}async closeAll(e="both"){for(const t of this.#t)t.type=="input"&&(e==="both"||e==="input")&&await t.close(),t.type=="output"&&(e==="both"||e==="output")&&await t.close()}async setOmniInput(e){this.#s=e,await this.closeAll("input"),e&&await this.#g()}get omniInput(){return this.#s}async setOmniOutput(e){this.#o=e,await this.closeAll("output"),e&&await this.#m()}get omniOutput(){return this.#o}async#g(){const e=this.#i;if(e){for(const[t,n]of e.inputs)if(n.connection==="closed"){if(this.#w(n))throw new Error("Bug: Input closed, but inUse?");await n.open()}}}async#m(){const e=this.#i;if(e){for(const[t,n]of e.outputs)if(n.connection==="closed"){if(this.#w(n))throw new Error("Bug: Output closed, but inUse?");await n.open()}}}dumpToStringLines(){const e=[],t=n=>` -  ${n.name} (${n.type}) state: ${n.state} conn: ${n.connection} id: ${n.id}`;return e.push("MidiManager"),e.push("In Use:"),e.push(...I(this.#t,t,"  (none)")),e.push("Known:"),e.push(...I(this.#e,t,"  (none)")),e}#y(e){const t=e.port;t!==null&&(t.state==="connected"?t.connection==="open"?this.#u(t):t.connection==="closed"&&(this.#f(t),this.#h(t),this.#s&&t.type==="input"?this.#c():this.#o&&t.type==="output"&&this.#r()):t.state==="disconnected"&&this.#p(t))}async open(e,t=!1){t&&(e.type==="input"?await this.closeAll("input"):e.type==="output"&&await this.closeAll("output")),e.open()}#d(e){this.verbose&&console.log("MIDI",e)}#v(e){this.#n={...this.#n,...e},this.#d(`State change: ${JSON.stringify(this.#n)}`)}async#b(){if(this.#n.initialised&&this.#i!==void 0)return;if((await navigator.permissions.query({name:"midi",software:!0,sysex:!1})).state==="denied"){this.#i=void 0,this.#v({initialised:!1,errorReason:"Permission denied"});return}this.#i=await navigator.requestMIDIAccess({software:!0,sysex:!1}),this.#i.addEventListener("statechange",t=>{this.#y(t)}),this.#v({initialised:!0,errorReason:""})}#x(){return!!navigator.requestMIDIAccess}#E(){if(!window.isSecureContext)throw new Error("Code is not running in a secure context. Load it via https");if(!this.#x())throw new Error("MIDI not supported in this browser")}findKnownPort(e){return this.#e.find(e)}*filterKnownPort(e){yield*this.#e.filter(e)}findInUsePort(e){return this.#t.find(e)}*filterInUsePort(e){yield*this.#t.filter(e)}},Be=class{channel=0;cc=-1;note=-1;output;portName;constructor(e={}){this.channel=e.channel??-1,this.cc=e.cc??-1,this.note=e.note??-1,this.output=e.output,this.portName=e.portName}setOutputPort(e){return e.type==="input"||this.portName!==void 0&&e.name!==e.name?!1:(this.output=e,!0)}sendRaw(e){if(!this.output||this.channel<0||this.cc<0&&this.note<0)return!1;let t;return this.cc>=0?(t={channel:this.channel,command:"cc",note:this.cc,velocity:e},console.log(t),this.output.send(v(t)),!0):(console.log(`sendNote: ch: ${this.channel} note: ${this.note} vel: ${e}`),F(this.output,this.channel,this.note,e,200),!0)}},Te=class Y extends y{static controlCount=0;inputChannel=1;inputCommand="cc";inputNote=-1;inputVelocityScale=[0,127];feedbackChannel=1;feedbackCommand="cc";feedbackNote=-1;feedbackVelocity=1;name=`Control-${Y.controlCount++}`;lastMessage;onInputMessage(t){return this.inputChannel>=0&&t.channel!==this.inputChannel||this.inputNote>=0&&t.note!==this.inputNote||this.inputCommand!==void 0&&t.command!==this.inputCommand?!1:(this.lastMessage=t,this.fireEvent("change",{velocity:t.velocity,velocityScaled:this.#n(t.velocity),control:this}),!0)}#n(t){return ae(t,this.inputVelocityScale[0],this.inputVelocityScale[1])}get scaledVelocity(){return this.lastMessage?this.#n(this.lastMessage.velocity):NaN}},Fe=class extends y{encoders=[];#n=-1;#i="disconnected";#t;#e;logOutgoing=!1;bankChangeChannel=4;sideButtonChannel=4;constructor(){super();for(let e=1;e<5;e++)for(let t=1;t<17;t++){const n=new Q(this,{bank:e,encoder:t});this.encoders.push(n),n.addEventListener("encoder",i=>{this.fireEvent("encoder",i)}),n.addEventListener("switch",i=>{this.fireEvent("switch",i)})}}#s=e=>{const t=e.port;t&&(t===this.#e&&(t.state==="disconnected"||t.connection==="closed")&&this.#c(),t===this.#t&&(t.state==="disconnected"||t.connection==="closed")&&this.#o(),this.#e!==void 0&&this.#t!==void 0?this.#r("ready"):this.#r("disconnected"))};#o(){const e=this.#t;e!==void 0&&(e.removeEventListener("statechange",this.#s),e.removeEventListener("midimessage",this.#l)),this.#t=void 0}#c(){const e=this.#e;e!==void 0&&e.removeEventListener("statechange",this.#s),this.#e=void 0}setPort(e){e.name==="Midi Fighter Twister"&&(e.type==="output"?(this.#c(),this.#e=e,this.#e!==void 0&&this.#e.addEventListener("statechange",this.#s)):e.type==="input"&&(this.#o(),this.#t=e,e!==void 0&&(this.#t.addEventListener("midimessage",this.#l),this.#t.addEventListener("statechange",this.#s)))),this.#e!==void 0&&this.#t!==void 0&&this.#r("ready")}#r(e){const t=this.#i;t!==e&&(this.#i=e,this.fireEvent("state",{previous:t,state:e,mf:this}))}#l=e=>{const t=e.data;if(!t)return;const n=M(t);if(n.channel===this.bankChangeChannel&&n.command==="cc"&&n.note<4){this.#a(n.note+1,!1);return}if(n.channel===this.sideButtonChannel&&n.command=="cc"){let i=-1,s,o;if(n.note===8?(i=1,s="top",o="left"):n.note===10?(i=1,o="left",s="bottom"):n.note===11?(i=1,o="right",s="top"):n.note===13?(i=1,o="right",s="bottom"):n.note===14?(i=2,o="left",s="top"):n.note===16?(i=2,o="left",s="bottom"):n.note===17?(i=2,o="right",s="top"):n.note===19?(i=2,o="right",s="bottom"):n.note===20?(i=3,s="top",o="left"):n.note===22?(i=3,s="bottom",o="left"):n.note===23?(i=3,s="top",o="right"):n.note==25?(i=3,s="bottom",o="right"):n.note==26?(i=4,s="top",o="left"):n.note==28?(i=4,s="bottom",o="left"):n.note==29?(i=4,s="top",o="right"):n.note==31&&(i=4,s="bottom",o="right"),s!==void 0&&o!==void 0){i!==this.#n&&this.#a(i,!0),this.fireEvent("sideButton",{bank:i,position:s,side:o,mf:this});return}}for(const i of this.encoders){if(i.inputEncoderChannel===n.channel&&i.inputEncoderNoteOrCc===n.note){i.onValueSet(n.velocity);return}if(i.inputSwitchChannel===n.channel&&i.inputSwitchNoteOrCc===n.note){i.onSwitchSet(n.velocity);return}}};#a(e,t){const n=this.#n;this.#n=e,n!==e&&this.fireEvent("bankChange",{prev:n,current:this.#n,mf:this,implicit:t})}set bank(e){if(e<1||e>4)throw new Error("Bank must be 1-4");this.#e&&(F(this.#e,this.bankChangeChannel,e-1,127,100),this.#a(e,!1))}get bank(){return this.#n}*getBank(e){if(typeof e>"u"&&(e=this.#n),e<1||e>4)throw new Error("Bank out of range, expected 1-4");for(const t of this.encoders)t.bank===e&&(yield t)}getEncoder(e,t){if(typeof t>"u"&&(t=this.#n),t<1||t>4)throw new Error(`Bank out of range, expected 1-4. Got: ${t}`);if(e<1||e>16)throw new Error("Encoder out of range, expected 1-16");return this.encoders.find(n=>n.bank===t&&n.encoder===e)}send(e){return this.#e?(this.logOutgoing&&console.log(`MF send: ${JSON.stringify(e)}`),this.#e.send(v(e)),!0):!1}get outputPort(){return this.#e}get inputPort(){return this.#t}get state(){return this.#i}},Q=class extends y{bank;encoder;inputEncoderNoteOrCc;inputEncoderChannel;inputSwitchChannel;inputSwitchNoteOrCc;ledEffectChannel=3;ledColourChannel=2;ledRingChannel=1;encoderStaticNote=0;lastEncoderValue=-1;lastSwitchValue=-1;constructor(e,t){super(),this.mf=e;const n=t.bank,i=t.encoder;if(n<0||n>4)throw new Error(`Expected bank value 1-4. Got: ${n}`);if(i<0||i>16)throw new Error(`Expected encoder number 1-16. Got: ${i}`);const s=(n-1)*16;this.encoderStaticNote=i-1+s,this.inputEncoderChannel=1,this.inputEncoderNoteOrCc=this.encoderStaticNote,this.inputSwitchChannel=2,this.inputSwitchNoteOrCc=this.encoderStaticNote,this.bank=n,this.encoder=i}onValueSet(e){const t=this.lastEncoderValue;this.lastEncoderValue=e,this.fireEvent("encoder",{previous:t,value:e,encoder:this})}onSwitchSet(e){const t=this.lastSwitchValue;this.lastSwitchValue=e,this.fireEvent("switch",{previous:t,value:e,encoder:this})}setLedRing(e){this.setLedRingRaw(re(Math.floor(e*127)))}setLedRingRaw(e){if(e<0||e>127)throw new Error("Param 'v' should be between 0-127");const t={channel:this.ledRingChannel,command:"cc",note:this.encoderStaticNote,velocity:e};this.mf.send(t)}setSwitchColourHue(e){if(e<0||e>1)throw new Error("Param 'v' should be in 0-1 range");let t=1-e+.7;t>1&&(t=t-1);const n=Math.floor(t*127);this.setSwitchColourRaw(n)}setSwitchColourRaw(e){if(e<0||e>127)throw new Error("Param 'v' should be between 0-127");const t={channel:this.ledColourChannel,command:"cc",note:this.encoderStaticNote,velocity:e};this.mf.send(t)}setSwitchEffect(e,t=1){let n=0;if(e==="rainbow")n=127;else if(e==="pulse"){if(t<1||t>7)throw new Error("Pulse effect expects a value 1-7");n=9+t}else if(e==="strobe"){if(t<1||t>8)throw new Error("Strobe effect expects a value 1-8");n=t}else if(e==="none")n=0;else throw new Error(`Unknown kind: '${e}'`);const i={channel:this.ledEffectChannel,command:"cc",note:this.encoderStaticNote,velocity:n};this.mf.send(i)}},ke={};m(ke,{Control:()=>Te,Feedback:()=>Be,MidiFighter:()=>Fe,MidiFighterEncoder:()=>Q,MidiManager:()=>Se,getParsedNotes:()=>E,noteNameToFrequency:()=>Ce,noteNameToNumber:()=>Ee,noteNumberToFrequency:()=>X,noteNumberToName:()=>K,pack:()=>v,sendNote:()=>F,unpack:()=>M});var k=class extends H{evalTimeoutMs;evalReplyBluetooth=!0;constructor(e,t={}){super(e,t),this.evalTimeoutMs=t.evalTimeoutMs??5*1e3}async writeScript(e){this.write(`reset();
`),this.write(`${e}
`)}async eval(e,t={},n){const i=t.debug??!1;return N(e,t,this,"Bluetooth.println",i,n??(o=>{this.warn(o)}))}},Ae=class extends y{states;codec;verboseLogging=!1;name;connectAttempts;chunkSize;rxBuffer;txBuffer;constructor(e={}){super(),this.verboseLogging=e.debug??!1,this.chunkSize=e.chunkSize??1024,this.connectAttempts=e.connectAttempts??3,this.name=e.name??"JsonDevice",this.txBuffer=new U(async t=>{await this.writeInternal(t)},e),this.rxBuffer=new W(t=>{this.fireEvent("data",{data:t})}),this.codec=new z,this.states=new G(_,{initial:"ready"}),this.states.addEventListener("change",t=>{this.fireEvent("change",t),this.verbose(`${t.priorState} -> ${t.newState}`),t.priorState==="connected"&&(this.rxBuffer.clear(),this.txBuffer.clear())})}get isConnected(){return this.states.state==="connected"}get isClosed(){return this.states.state==="closed"}write(e){if(this.states.state!=="connected")throw new Error(`Cannot write while state is ${this.states.state}`);this.txBuffer.add(e)}async close(){this.states.state==="connected"&&this.onClosed()}async connect(){const e=this.connectAttempts;this.states.state="connecting",await this.onPreConnect(),await V(async()=>(await this.onConnectAttempt(),this.states.state="connected",!0),{limitAttempts:e,startAt:200})}onRx(e){const t=e.target.value;if(t===void 0)return;let n=this.codec.fromBuffer(t.buffer);const i=S(n,19),s=S(n,17);s&&i<s&&(this.verbose("Tx plz start"),n=B(n,s,1),this.txBuffer.paused=!1),i&&i>s&&(this.verbose("Tx plz stop"),n=B(n,i,1),this.txBuffer.paused=!0),this.rxBuffer.add(n)}verbose(e){this.verboseLogging&&console.info(this.name,e)}log(e){console.log(this.name,e)}warn(e){console.warn(this.name,e)}},De={};m(De,{Device:()=>Z});var Z=class extends Ae{port;tx;abort;baudRate;constructor(e={}){super(e),this.config=e,this.abort=new AbortController;const t=e.eol??`\r
`;this.baudRate=e.baudRate??9600,e.name===void 0&&(this.name="Serial.Device"),this.rxBuffer.separator=t}async writeInternal(e){if(this.tx===void 0)throw new Error("tx not ready");try{this.tx.write(e)}catch(t){this.warn(t)}}onClosed(){this.tx?.releaseLock(),this.abort.abort("closing port"),this.states.state="closed"}onPreConnect(){return Promise.resolve()}async onConnectAttempt(){let e={filters:[]};const t={baudRate:this.baudRate};this.config.filters&&(e={filters:[...this.config.filters]}),this.port=await navigator.serial.requestPort(e),this.port.addEventListener("disconnect",r=>{this.close()}),await this.port.open(t);const n=this.port.writable,i=new TextEncoderStream;n!==null&&(i.readable.pipeTo(n,{signal:this.abort.signal}).catch(r=>{console.log("Serial.onConnectAttempt txText pipe:"),console.log(r)}),this.tx=i.writable.getWriter());const s=this.port.readable,o=new TextDecoderStream;s!==null&&(s.pipeTo(o.writable,{signal:this.abort.signal}).catch(r=>{console.log("Serial.onConnectAttempt rxR pipe:"),console.log(r)}),o.readable.pipeTo(this.rxBuffer.writable(),{signal:this.abort.signal}).catch(r=>{console.log("Serial.onConnectAttempt rxText pipe:"),console.log(r);try{this.port?.close()}catch(a){console.log(a)}}))}},ee=class extends Z{evalTimeoutMs;evalReplyBluetooth=!1;constructor(e){super(e),e===void 0&&(e={}),this.evalTimeoutMs=e.evalTimeoutMs??5*1e3}async disconnect(){return super.close()}writeScript(e){this.write(`reset();
`),this.write(`${e}
`)}async eval(e,t={},n){const i=t.debug??!1;return N(e,t,this,"USB.println",i,n??(o=>{this.warn(o)}))}},Me={};m(Me,{EspruinoBleDevice:()=>k,EspruinoSerialDevice:()=>ee,bangle:()=>Ne,connectBle:()=>Pe,deviceEval:()=>N,puck:()=>qe,serial:()=>$e});const qe=async(e={})=>{const t=e.name??"Puck",n=e.debug??!1,i=await navigator.bluetooth.requestDevice({filters:q(e,"Puck.js"),optionalServices:[x.service]});e.debug&&console.info(`Espruino.puck device name: ${i.name}`);const s=new k(i,{name:t,debug:n});return await s.connect(),s},Ne=async(e={})=>{const t=e.name??"Bangle",n=e.debug??!1,i=await navigator.bluetooth.requestDevice({filters:q(e,"Bangle.js"),optionalServices:[x.service]});e.debug&&console.info(`Espruino.bangle device name: ${i.name}`);const s=new k(i,{name:t,debug:n});return await s.connect(),s},$e=async(e={})=>{const t=new ee(e);return await t.connect(),t},q=(e,t)=>{const n=[];return e.filters?n.push(...e.filters):e.name?(n.push({name:e.name}),console.info(`Filtering Bluetooth devices by name '${e.name}'`)):n.push({namePrefix:t}),n},Pe=async(e={})=>{const t=await navigator.bluetooth.requestDevice({filters:q(e,"Puck.js"),optionalServices:[x.service]}),n=new k(t,{name:"Espruino",...e});return await n.connect(),n},N=async(e,t={},n,i,s,o)=>{const r=t.timeoutMs??n.evalTimeoutMs,a=t.assumeExclusive??!0;if(typeof e!="string")throw new TypeError(`Param 'code' should be a string. Got: ${typeof e}`);return new Promise((h,c)=>{const w=ce(5),u=d=>{try{let f=d.data.trim();f.startsWith(">{")&&f.endsWith("}")&&(f=f.slice(1));const b=JSON.parse(f);"reply"in b?b.reply===w?(p(),"result"in b&&h(b.result)):o(`Expected reply ${w}, got ${b.reply}`):o(`Expected packet, missing 'reply' field. Got: ${d.data}`)}catch(f){a?p(`Unexpected reply: ${d.data}. Error: ${D(f)}`):o(D(f))}},l=d=>{d.newState!=="connected"&&p(`State changed to '${d.newState}', aborting`)};n.addEventListener("data",u),n.addEventListener("change",l);const p=O(r,d=>{c(new Error(d))},d=>{n.removeEventListener("data",u),n.removeEventListener("change",l)}),g=`${i}(JSON.stringify({reply:"${w}", result:JSON.stringify(${e})}))
`;s&&o(g),n.write(g)})};var Ie={};m(Ie,{dumpDevices:()=>Re,start:()=>Oe});const Le=1e4,Re=async(e="videoinput")=>{const t=await navigator.mediaDevices.enumerateDevices();for(const n of t)n.kind===e&&(console.log(n.label),console.log(` Kind: ${n.kind}`),console.log(` Device id: ${n.deviceId}`))},Oe=async(e={})=>{const t=document.createElement("VIDEO");t.style.display="none",t.playsInline=!0,t.muted=!0,t.classList.add("ixfx-camera"),document.body.append(t);let n=()=>{};const i=()=>{try{n()}catch{}t.remove()};try{return n=(await Ge(t,e)).dispose,{videoEl:t,dispose:i}}catch(s){throw console.error(s),i(),s}},Ge=async(e,t={})=>{if(e===void 0)throw new Error("videoEl undefined");if(e===null)throw new Error("videoEl null");const n=t.max,i=t.min,s=t.ideal,o={audio:!1,video:{width:{},height:{}}};t.facingMode==="front"&&(t={...t,facingMode:"user"}),t.facingMode==="back"&&(t={...t,facingMode:"environment"}),t.facingMode&&(o.video.facingMode=t.facingMode),t.deviceId&&(o.video.deviceId=t.deviceId),s&&(o.video.width={...o.video.width,ideal:s.width},o.video.height={...o.video.height,ideal:s.height}),n&&(o.video.width={...o.video.width,max:n.width},o.video.height={...o.video.height,max:n.height}),i&&(o.video.width={...o.video.width,min:i.width},o.video.height={...o.video.height,min:i.height});const r=O(t.startTimeoutMs??Le,a=>{throw new Error(`Camera getUserMedia failed: ${a}`)});try{const a=await navigator.mediaDevices.getUserMedia(o),h=()=>{e.pause();const u=a.getTracks();for(const l of u)l.stop()};e.srcObject=a,r();const c={videoEl:e,dispose:h};return new Promise((u,l)=>{e.addEventListener("loadedmetadata",()=>{e.play().then(()=>{u(c)}).catch(p=>{l(p)})})})}catch(a){throw r(D(a)),a}};var Ve={};m(Ve,{start:()=>ze});const ze=async e=>{const t=document.createElement("VIDEO");t.style.display="none",t.playsInline=!0,t.muted=!0,t.classList.add("ixfx-video"),document.body.appendChild(t);let n=()=>{};const i=()=>{try{n()}catch{}t.remove()};try{return n=(await We(t,e)).dispose,{videoEl:t,dispose:i}}catch(s){throw console.error(s),i(),s}},We=async(e,t)=>{if(e===void 0)throw new Error("videoEl undefined");if(e===null)throw new Error("videoEl null");const n=URL.createObjectURL(t);e.src=n,e.loop=!0;const s={videoEl:e,dispose:()=>{e.pause()}};return new Promise((r,a)=>{e.addEventListener("loadedmetadata",()=>{e.play().then(()=>{r(s)}).catch(h=>{a(h)})})})};export{Me as e,ke as m};
